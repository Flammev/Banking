<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Rift Pay - Transfert d'argent instantan√©">
    <meta name="theme-color" content="#0f172a">
    <title>Transfert - Rift Pay</title>
    {% load static currency_filters %}
    <link rel="stylesheet" href="{% static 'transfer.css' %}?v=2">
</head>
<body>
    <div class="app">
        <!-- ‚îÄ‚îÄ‚îÄ Top Bar (same as dashboard) ‚îÄ‚îÄ‚îÄ -->
        <header class="topbar">
            <div class="topbar-inner">
                <div class="brand">Rift<span>Pay</span></div>
                <nav class="nav">
                    <a href="{% url 'home' %}" class="nav-link">Dashboard</a>
                    <a href="{% url 'transfer' %}" class="nav-link active">Transfert</a>
                    <a href="{% url 'history' %}" class="nav-link">Historique</a>
                </nav>
                <a href="{% url 'logout' %}" class="logout-btn" title="D√©connexion">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </a>
            </div>
        </header>

        <!-- ‚îÄ‚îÄ‚îÄ Main Content ‚îÄ‚îÄ‚îÄ -->
        <main class="main">
            <div class="transfer-card">
                <div class="transfer-header">
                    <h1>Transfert d'argent</h1>
                    <p>Envoyez de l'argent en toute s√©curit√©</p>
                </div>

                <form method="POST" class="transfer-form">
                    {% csrf_token %}

                    <!-- Flash messages -->
                    <div id="flash-message"></div>
                    {% if success %}
                        <div class="alert alert-success" data-message="success">
                            <strong>Succ√®s !</strong> {{ success }}
                        </div>
                    {% endif %}
                    {% if error %}
                        <div class="alert alert-error" data-message="error">
                            <strong>Erreur !</strong> {{ error }}
                        </div>
                    {% endif %}

                    <!-- Lookup Type -->
                    <div class="form-group">
                        <label class="form-label">Rechercher par</label>
                        <div class="lookup-tabs">
                            <button type="button" class="lookup-tab active" data-type="email">
                                <span class="tab-icon">‚úâÔ∏è</span><span>Email</span>
                            </button>
                            <button type="button" class="lookup-tab" data-type="phone">
                                <span class="tab-icon">üì±</span><span>T√©l√©phone</span>
                            </button>
                            <button type="button" class="lookup-tab" data-type="account">
                                <span class="tab-icon">üè¶</span><span>N¬∞ Compte</span>
                            </button>
                        </div>
                    </div>

                    <!-- Recipient Lookup -->
                    <div class="form-group">
                        <label for="recipient_lookup" class="form-label">
                            <span id="lookup-label">Email du destinataire</span>
                        </label>
                        <div class="input-wrapper">
                            <span class="input-icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                            </span>
                            <input type="text" id="recipient_lookup" name="recipient_lookup" required class="form-input" placeholder="Entrez l'email du destinataire">
                            <input type="hidden" id="lookup_type" name="lookup_type" value="email">
                        </div>
                        <small class="form-hint" id="lookup-hint">Le destinataire doit avoir un compte Rift Pay</small>
                    </div>

                    <!-- Recipient Name -->
                    <div class="form-group">
                        <label for="receiver_name" class="form-label">Nom du destinataire</label>
                        <div class="input-wrapper">
                            <span class="input-icon">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            </span>
                            <input type="text" id="receiver_name" name="receiver_name" readonly class="form-input" placeholder="Le nom appara√Ætra ici">
                        </div>
                        <input type="hidden" id="receiver_id" name="receiver_id">
                    </div>

                    <!-- Amount -->
                    <div class="form-group">
                        <label for="amount" class="form-label">Montant</label>
                        <div class="input-wrapper">
                            <span class="input-icon currency">F</span>
                            <input type="number" id="amount" name="amount" required step="0.01" min="0.01" class="form-input amount-input" placeholder="0.00">
                        </div>
                        <small class="form-hint">Montant minimum : 0.01 FCFA</small>
                    </div>

                    <!-- Balance -->
                    <div class="balance-banner">
                        <small>Solde disponible</small>
                        <strong id="available-balance">{{ available_balance|default:0|fcfa }}</strong>
                    </div>

                    <!-- Description -->
                    <div class="form-group">
                        <label for="description" class="form-label">Description (optionnel)</label>
                        <textarea id="description" name="description" class="form-textarea" placeholder="Ajoutez une note‚Ä¶" rows="3" maxlength="256"></textarea>
                        <small class="form-hint"><span id="char-count">0</span>/256 caract√®res</small>
                    </div>

                    <!-- Summary -->
                    <div class="transfer-summary">
                        <span>Montant du transfert</span>
                        <span id="summary-amount">{{ 0|fcfa }}</span>
                    </div>

                    <!-- Buttons -->
                    <div class="btn-row">
                        <button type="submit" class="btn btn--primary">Transf√©rer</button>
                        <button type="reset" class="btn btn--ghost">Effacer</button>
                    </div>

                    <div class="back-link">
                        <a href="{% url 'home' %}">‚Üê Retour au Dashboard</a>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script>
        // Lookup type tabs
        const lookupTabs = document.querySelectorAll('.lookup-tab');
        const recipientLookupInput = document.getElementById('recipient_lookup');
        const lookupTypeInput = document.getElementById('lookup_type');
        const lookupLabel = document.getElementById('lookup-label');
        const lookupHint = document.getElementById('lookup-hint');
        const receiverNameInput = document.getElementById('receiver_name');
        const transferForm = document.querySelector('.transfer-form');
        const availableBalanceElement = document.getElementById('available-balance');
        const flashMessage = document.getElementById('flash-message');

        function formatFcfa(value) {
            const parsed = Number(value || 0);
            return parsed.toLocaleString('fr-FR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }) + ' FCFA';
        }

        const lookupConfig = {
            email: {
                label: 'Email du destinataire',
                placeholder: 'Entrez l\'email du destinataire',
                hint: 'Le destinataire doit avoir un compte Rift Pay'
            },
            phone: {
                label: 'T√©l√©phone du destinataire',
                placeholder: 'Entrez le num√©ro de t√©l√©phone',
                hint: 'Le destinataire doit avoir un compte Rift Pay'
            },
            account: {
                label: 'Num√©ro de compte',
                placeholder: 'Entrez le num√©ro de compte',
                hint: 'Le destinataire doit avoir un compte Rift Pay'
            }
        };

        // Handle lookup tab changes
        lookupTabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                const type = tab.getAttribute('data-type');
                lookupTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                lookupTypeInput.value = type;
                recipientLookupInput.value = '';
                receiverNameInput.value = '';
                receiverNameInput.style.color = '';
                lookupLabel.textContent = lookupConfig[type].label;
                recipientLookupInput.placeholder = lookupConfig[type].placeholder;
                lookupHint.textContent = lookupConfig[type].hint;
                recipientLookupInput.focus();
            });
        });

        // Update amount display
        const amountInput = document.getElementById('amount');
        const summaryAmount = document.getElementById('summary-amount');
        amountInput.addEventListener('input', function() {
            summaryAmount.textContent = formatFcfa(parseFloat(this.value) || 0);
        });

        // Character counter
        const descriptionTextarea = document.getElementById('description');
        const charCount = document.getElementById('char-count');
        if (descriptionTextarea && charCount) {
            descriptionTextarea.addEventListener('input', function() {
                charCount.textContent = this.value.length;
            });
        }

        // Fetch recipient info
        recipientLookupInput.addEventListener('blur', function() {
            if (this.value) {
                fetchRecipientInfo(this.value, lookupTypeInput.value);
            } else {
                receiverNameInput.value = '';
            }
        });

        function fetchRecipientInfo(value, type) {
            receiverNameInput.value = 'Chargement...';
            receiverNameInput.style.color = 'var(--muted)';
            fetch(`/api/recipient-info/?value=${encodeURIComponent(value)}&type=${type}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        receiverNameInput.value = data.name;
                        receiverNameInput.style.color = 'var(--text)';
                        document.getElementById('receiver_id').value = data.user_id;
                    } else {
                        receiverNameInput.value = data.error || 'Utilisateur introuvable';
                        receiverNameInput.style.color = 'var(--red)';
                        document.getElementById('receiver_id').value = '';
                    }
                })
                .catch(() => {
                    receiverNameInput.value = 'Erreur de chargement';
                    receiverNameInput.style.color = 'var(--red)';
                });
        }

        function renderFlash(type, message) {
            if (!flashMessage) return;
            const cls = type === 'success' ? 'alert-success' : 'alert-error';
            const title = type === 'success' ? 'Succ√®s !' : 'Erreur !';
            flashMessage.innerHTML = `<div class="alert ${cls}" data-message="${type}"><strong>${title}</strong> ${message}</div>`;
            setTimeout(() => { flashMessage.innerHTML = ''; }, 5000);
        }

        function updateBalanceDisplay(value) {
            if (availableBalanceElement) availableBalanceElement.textContent = formatFcfa(value);
        }

        if (transferForm) {
            transferForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const submitBtn = transferForm.querySelector('.btn--primary');
                const origLabel = submitBtn ? submitBtn.textContent : null;
                if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Traitement...'; }

                try {
                    const response = await fetch(window.location.pathname, {
                        method: 'POST',
                        body: new FormData(transferForm),
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' },
                        credentials: 'same-origin'
                    });
                    const data = await response.json();
                    if (!response.ok || !data.success) {
                        renderFlash('error', data.error || 'Le transfert a √©chou√©');
                        updateBalanceDisplay(data.available_balance);
                        return;
                    }
                    renderFlash('success', data.message || 'Transfert effectu√© avec succ√®s');
                    updateBalanceDisplay(data.available_balance);
                    transferForm.reset();
                    receiverNameInput.value = '';
                    document.getElementById('receiver_id').value = '';
                    summaryAmount.textContent = formatFcfa(0);
                    if (charCount) charCount.textContent = '0';
                } catch (e) {
                    renderFlash('error', 'Erreur r√©seau');
                } finally {
                    if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = origLabel || 'Transf√©rer'; }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const msgs = document.querySelectorAll('[data-message]');
            msgs.forEach(m => setTimeout(() => m.style.display = 'none', 5000));
        });
    </script>
</body>
</html>